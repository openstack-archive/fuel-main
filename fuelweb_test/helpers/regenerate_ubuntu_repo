#!/bin/bash
# Based on the method described here:
# http://troubleshootingrange.blogspot.com/2012/09/hosting-simple-apt-repository-on-centos.html
#
# Example of the use of the script (For CentOS only. For Ubuntu, please use apt-ftparchive utility instead):
# 1) Login to the CentOS node where the Ubuntu repository is located (Fuel master node, for example).
#                            Your Ubuntu repository must have an './indices/' folder with correct
#                            'override.*' files for the repository. Fuel master node >=5.1 already has it.
# 2) Copy additional packages to the Ubuntu repository if needed.
#                            Please pay attention: this script works only with *.deb packages
#                            located in the ./pool/main folder of the repository.
# 3) yum install dpkg dpkg-devel # These packets can be taken from http://mirror.fuel-infra.org/fwm/
#                                # They are already in the Fuel master node starting from version >=5.1
# 4) Copy this script to the CentOS node to any location, for example to /tmp/regenerate_ubuntu_repo
# 5) Set the path to the Ubuntu repository using the variable REPO_PATH and start the script:
#    REPO_PATH=/var/www/nailgun/ubuntu/x86_64 sh /tmp/regenerate_ubuntu_repo
# 6) Done.


ARCH=amd64
VERSION=12.04
REPONAME=precise

BINDIR=${REPO_PATH}/dists/${REPONAME}/main

binoverride=indices/override.${REPONAME}.main
extraoverride=indices/override.${REPONAME}.extra.main

package_deb=${BINDIR}/binary-amd64/Packages

cd ${REPO_PATH}

# Scan *.deb packages
dpkg-scanpackages  -m --extra-override ${extraoverride} -a ${ARCH} pool/main ${binoverride}  > $package_deb 2>/dev/null

gzip -9c $package_deb > ${package_deb}.gz

# Generate release file
cd ${REPO_PATH}/dists/${REPONAME}
cat > Release <<ENDRELEASE
Architectures: ${ARCH}
Codename: ${REPONAME}
Components: main
Description: Ubuntu Precise 12.04 LTS
Label: Ubuntu
Origin: Ubuntu
Suite: ${REPONAME}
Version: ${VERSION}
ENDRELEASE

# Generate hashes
c1=(MD5Sum: SHA1: SHA256: SHA512:)
c2=(md5 sha1 sha256 sha512)

i=0
while [ $i -lt ${#c1[*]} ]; do
    echo ${c1[i]} >> Release
        for hashme in `find main -type f \( -name "Package*" -o -name "Release*" \)`; do
        chash=`openssl dgst -${c2[$i]} ${hashme}|cut -d" " -f 2`
        size=`stat -c %s ${hashme}`
        echo " ${chash} ${size} ${hashme}" >> Release
    done
    i=$(( $i + 1));
done

cd -
